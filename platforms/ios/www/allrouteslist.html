<script src='cordova.js' type='text/javascript' charset='utf-8'></script>
<script type="text/javascript" src="js/camera.js"></script>
<script type="text/javascript" src="js/session_admin.js"></script>
<script type="text/javascript" src="js/conection_whit_api.js"></script>
<script type="text/javascript" src="js/database.js"></script>
<main class="mdl-layout__content settings">
<p class="title">{{title}}</p>
{{#each routes}}
<div class="lecture" id="{{@index}}" style="display:none;">
  <center>
  <div class="round-number">{{inc @index}}</div>
  <b>Dirección:</b>{{address}}</br>
  <b>Colonia:</b>{{colony}}</br>
  </center>
  <div id="route-{{Id}}" class="superinput">
    <div id="step1-{{Id}}">
      <center>Seleccióne el tipo de dato a insertar</center>
      <div id="firstbuttons{{Id}}">
        <div class="btn-blue-bordered" onclick="openLEcture({{Id}})">Toma de lectura</div>
        <div class="btn-blue-bordered" onclick="openAnomaly({{Id}})">Anomalía</div>
      </div>
      <div id="lecture-{{Id}}" class="mid-form" style="display:none;">
        <input type="text" id="lecture{{Id}}" data-name="lecture" placeholder="Ingresa la lectura"  data-idx="{{Id}}" class="lecture{{Id}}" required>
        <center>
        <div class="button-round" data-target="lecture{{Id}}" data-steap="2" data-idx="{{Id}}"><i class="fa fa-arrow-circle-o-right" style="float:none; margin:2px;"></i></div>
        </center>
      </div>
      <div id="anomaly-{{Id}}" class="mid-form" style="display:none;">
        <input type="text" id="abnormalities{{Id}}" data-name="abnormalities" placeholder="Ingresa cualquier anormalidad"  data-idx="{{Id}}" class="abnormalities{{Id}}" required>
        <center>
        <div class="button-round" data-target="abnormalities{{Id}}" data-steap="2" data-idx="{{Id}}"><i class="fa fa-arrow-circle-o-right" style="float:none; margin:2px;"></i></div>
        </center>
      </div>
    </div>
    <div id="step2-{{Id}}" style="display:none;">
          <center><div class="btncamera" onclick="openCature({{Id}});"><i class="fa fa-camera-retro" style="margin:1px; float:none;"></i></div></center>
          <div class="image-form{{Id}}" id="images-adding{{Id}}" style="width:100%; margin-bottom:50px;"></div>
          <center>
          <div class="button-round-save">
          <a onclick="validateImages({{Id}}, {{inc @index}})"  ><i class="fa fa-floppy-o" style="margin: 5px; float: none;"></i></a>
          </div>
          </center>
          <script type="text/javascript">
            var dateinsert = new Date().toLocaleString();
            $('#data_access{{Id}}').val(dateinsert);
          </script>
          <input type="text" id="data_access{{Id}}" data-name="data_access" data-idx="{{Id}}" style="display:none;" >
          <input type="text" id="to_id{{Id}}"  data-name="to_id" data-idx="{{Id}}" value="{{Id}}" style="display:none;">
          <input type="text" name="observations" id="observations{{Id}}" placeholder="Ingresa cualquier observación" data-idx="{{Id}}" style="display:none;" value="no">
          <input type="text" name="reference" id="reference{{Id}}" placeholder="Ingresa cualquier observación" data-idx="{{Id}}" style="display:none;" value="no">
    </div>
  </div>
</div>
{{/each}}
</main>

<script type="text/javascript">
  function paginateRoutes(indexroute){
    $(".lecture").hide();
    $("#"+indexroute).show();
    var conf = String(indexroute);
    window.localStorage.setItem("lecture", conf);
  }
  
  function openCature(id){
    window.localStorage.setItem("lecturex", String(id));
    capturePhoto();
  }

  if (window.localStorage.getItem("lecture") == undefined){
    window.localStorage.setItem("lecture", "0");
    var lecture = window.localStorage.getItem("lecture");
    $('#'+lecture).show();
   }else{
    var lecture = window.localStorage.getItem("lecture");
    $('#'+lecture).show();
  }

  function openLEcture(id){
     $('#lecture-'+id).slideToggle('slow');
     $('#firstbuttons'+id).slideToggle();
  }

  function openAnomaly(id){
     $('#anomaly-'+id).slideToggle('slow');
     $('#firstbuttons'+id).slideToggle();
  }

  $('.button-round').click(function(){
    var target =  $(this).data('target');
    var valuex = $('.'+target).val();
    var Idx =  $(this).data('idx');
    var steap = $(this).data('steap');
    var idtoGo = "step" + steap + "-" + Idx;
    console.log(idtoGo);
    var notStep = steap - 1;
    console.log(notStep);
    var hideSteap = "step" + notStep + "-" + Idx;
    console.log(hideSteap);
    if (valuex == ''){
      alert('Necesita llenar el campo para continuar');
    }else{
      $('#'+hideSteap).hide();
      $('#'+idtoGo).show();

    }
  });

  function validateImages(id, indexroute){
    var countimges = $("#step2-"+id+ " img").length;
    var idupdate = "route-"+id;

    if (countimges == 3){
       updateLecture(idupdate);
       paginateRoutes(indexroute);
       alert("Se ha guardado la ruta correctamente");
    }else{
      var message = "Actualmente usted ha ingresado "+ countimges + "imagenes el requerido son 3";
      alert(message);
    }
  }

  function updateLecture(idupdate) {

  $('#'+idupdate+' input[type=text]').each(function(i) {
    var input = $(this);
    var valuex = input.val();
    var field = input.data('name');
    var id = input.data('idx');
    console.log(field);
    console.log(valuex);
    console.log(id);
    if (field != "to_id") {
      if (valuex != "") {
        updateQuery("routes", field, valuex, id);
      }
    }else{
      createImagesFO(id);
    }
  });
  }

  function createImagesFO(id){
   var iterator =  "images-adding"+id;
   setTimeout(function() {
      $('#'+iterator+' input[type=text]').each(function(i) {
      var input = $(this);
      var value = input.val();
      var type = "routes";
      var data_images = [value, id, type];
      var im = insertData(data_images, "images", myDataBase, Schema, false);
      });
   },1000);

  }


  
  
</script>